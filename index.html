<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>閱讀進度表</title>
    <link rel="stylesheet" href="css.css">
</head>
<body>
    <div class="header">
        <div class="nav-month">
            <h1>閱讀進度表</h1>
            <button class="btn" id="prevMonth">&lt;</button>
            <span id="currentMonth"></span>
            <button class="btn" id="nextMonth">&gt;</button>
        </div>
    </div>

    <div class="subject-form">
        <input type="text" id="subjectName" placeholder="新增主題">
        <input type="color" id="subjectColor" value="#000000">
        <button class="btn" id="addSubject">新增主題</button>
    </div>

    <div class="schedule-container">
        <div class="schedule-grid" id="scheduleGrid">
            <!-- Grid will be generated by JavaScript -->
        </div>
    </div>

    <p class="help-text">
        點擊格子新增閱讀時段。點擊已有時段更新進度。拖放時段可重新安排時間。
    </p>

    <script>
        class ReadingSchedule {
            constructor() {
                this.subjects = JSON.parse(localStorage.getItem('subjects')) || [
                    { id: 1, name: '小說', color: '#4CAF50' },
                    { id: 2, name: '非小說', color: '#2196F3' },
                    { id: 3, name: '技術書籍', color: '#9C27B0' }
                ];
                this.sessions = JSON.parse(localStorage.getItem('sessions')) || [];
                this.currentDate = new Date();
                this.draggedSession = null;

                this.initializeElements();
                this.attachEventListeners();
                this.render();
            }

            initializeElements() {
                this.elements = {
                    grid: document.getElementById('scheduleGrid'),
                    subjectName: document.getElementById('subjectName'),
                    subjectColor: document.getElementById('subjectColor'),
                    addSubjectBtn: document.getElementById('addSubject'),
                    prevMonthBtn: document.getElementById('prevMonth'),
                    nextMonthBtn: document.getElementById('nextMonth'),
                    currentMonthSpan: document.getElementById('currentMonth')
                };
            }

            attachEventListeners() {
                this.elements.addSubjectBtn.addEventListener('click', () => this.addSubject());
                this.elements.prevMonthBtn.addEventListener('click', () => this.previousMonth());
                this.elements.nextMonthBtn.addEventListener('click', () => this.nextMonth());
            }

            addSubject() {
                const name = this.elements.subjectName.value.trim();
                const color = this.elements.subjectColor.value;

                if (name) {
                    this.subjects.push({
                        id: Date.now(),
                        name,
                        color
                    });
                    this.elements.subjectName.value = '';
                    this.saveData();
                    this.render();
                }
            }

            deleteSubject(id) {
                this.subjects = this.subjects.filter(subject => subject.id !== id);
                this.sessions = this.sessions.filter(session => session.subjectId !== id);
                this.saveData();
                this.render();
            }

            addSession(hour, date, subjectId) {
                this.sessions.push({
                    id: Date.now(),
                    subjectId,
                    date: date.toISOString().split('T')[0],
                    hour,
                    progress: 0
                });
                this.saveData();
                this.render();
            }

            updateProgress(sessionId) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session) {
                    session.progress = (session.progress + 25) % 125;
                    this.saveData();
                    this.render();
                }
            }

            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.render();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.render();
            }

            formatDate(date) {
                return date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long'
                });
            }

            getDaysInMonth(date) {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            }

            saveData() {
                localStorage.setItem('subjects', JSON.stringify(this.subjects));
                localStorage.setItem('sessions', JSON.stringify(this.sessions));
            }

            render() {
                this.elements.currentMonthSpan.textContent = this.formatDate(this.currentDate);
                this.elements.grid.style.setProperty('--subject-count', this.subjects.length);

                // Clear grid
                this.elements.grid.innerHTML = '';

                // Add headers
                this.elements.grid.appendChild(this.createTimeHeader());
                this.subjects.forEach(subject => {
                    this.elements.grid.appendChild(this.createSubjectHeader(subject));
                });

                // Add time slots and cells
                const daysInMonth = this.getDaysInMonth(this.currentDate);
                for (let i = 0; i < daysInMonth * 24; i++) {
                    const hour = i % 24;
                    const day = Math.floor(i / 24) + 1;
                    const date = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);

                    this.elements.grid.appendChild(this.createTimeSlot(date, hour));
                    this.subjects.forEach(subject => {
                        this.elements.grid.appendChild(this.createScheduleCell(date, hour, subject));
                    });
                }
            }

            createTimeHeader() {
                const header = document.createElement('div');
                header.className = 'grid-header';
                header.textContent = '時間';
                return header;
            }

            createSubjectHeader(subject) {
                const header = document.createElement('div');
                header.className = 'grid-header subject-header';
                header.style.color = subject.color;

                const name = document.createElement('span');
                name.textContent = subject.name;
                header.appendChild(name);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.onclick = () => this.deleteSubject(subject.id);
                header.appendChild(deleteBtn);

                return header;
            }

            createTimeSlot(date, hour) {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                
                if (hour === 0) {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-header';
                    dateHeader.textContent = `${date.getDate()}日`;
                    slot.appendChild(dateHeader);
                }
                
                slot.appendChild(document.createTextNode(
                    `${hour.toString().padStart(2, '0')}:00`
                ));
                
                return slot;
            }

            createScheduleCell(date, hour, subject) {
                const cell = document.createElement('div');
                cell.className = 'schedule-cell';
                cell.onclick = () => this.addSession(hour, date, subject.id);

                const sessions = this.sessions.filter(session => 
                    session.subjectId === subject.id &&
                    session.hour === hour &&
                    session.date === date.toISOString().split('T')[0]
                );

                sessions.forEach(session => {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = 'reading-session';
                    sessionDiv.style.backgroundColor = subject.color;
                    sessionDiv.style.opacity = '0.7';
                    sessionDiv.draggable = true;

                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${100 - session.progress}%`;
                    progressBar.style.opacity = '0.5';
                    sessionDiv.appendChild(progressBar);

                    sessionDiv.onclick = (e) => {
                        e.stopPropagation();
                        this.updateProgress(session.id);
                    };

                    sessionDiv.ondragstart = () => {
                        this.draggedSession = session;
                    };

                    cell.appendChild(sessionDiv);
                });

                cell.ondragover = (e) => e.preventDefault();
                cell.ondrop = () => {
                    if (this.draggedSession) {
                        const index = this.sessions.findIndex(s => s.id === this.draggedSession.id);
                        if (index !== -1) {
                            this.sessions[index] = {
                                ...this.draggedSession,
                                subjectId: subject.id,
                                hour: hour,
                                date: date.toISOString().split('T')[0]
                            };
                            this.draggedSession = null;
                            this.saveData();
                            this.render();
                        }
                    }
                };

                return cell;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ReadingSchedule();
        });
    </script>
</body>
</html>